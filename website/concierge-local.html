<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Atlas Masa AI Studio | אטלס מסע</title>
    <meta
      name="description"
      content="מערכת AI אישית לניידות, עבודה וחיים: קונסיירז', סטודיו תשובות, סקר מותאם בזמן אמת ופיד יזום."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        padding-bottom: 28px;
      }

      .concierge-app {
        display: grid;
        gap: 14px;
      }

      .concierge-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .panel {
        padding: 16px;
      }

      .panel h2,
      .panel h3 {
        margin-bottom: 10px;
      }

      .subtle {
        color: var(--muted);
      }

      .segment {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.04);
        color: var(--ink);
        border-radius: 999px;
        padding: 8px 12px;
        font-weight: 800;
        cursor: pointer;
      }

      .chip[aria-pressed="true"] {
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.58), rgba(46, 230, 166, 0.24));
        border-color: rgba(124, 92, 255, 0.35);
      }

      .field {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }

      .field label {
        font-weight: 800;
      }

      .field input,
      .field textarea,
      .field select {
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.24);
        color: var(--ink);
      }

      .field textarea {
        min-height: 120px;
      }

      .actions {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .output {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 14px;
        padding: 14px;
        min-height: 190px;
        white-space: pre-wrap;
      }

      .tag-row {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tag {
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .stack {
        display: grid;
        gap: 10px;
      }

      .tile {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        padding: 12px;
      }

      .tile h4 {
        margin: 0 0 8px;
      }

      .tile p {
        margin: 0;
        color: var(--muted);
      }

      .pill-line {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .muted-line {
        color: var(--muted2);
        font-size: 12px;
      }

      .survey-card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.03);
        padding: 12px;
        margin-top: 10px;
      }

      .survey-progress {
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }

      .survey-progress > span {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.65), rgba(46, 230, 166, 0.45));
      }

      .feature-block {
        display: none;
      }

      .feature-block.active {
        display: block;
      }

      .action-list {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .action-list .btn {
        font-size: 13px;
        padding: 9px 11px;
      }

      .status-ok {
        color: #77ffc5;
      }

      .status-warn {
        color: #ffd28f;
      }

      .voice-state {
        font-size: 12px;
        color: var(--muted2);
      }

      .debug {
        margin-top: 12px;
      }

      .raw {
        margin-top: 8px;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.5;
        background: rgba(0, 0, 0, 0.32);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 10px;
        padding: 10px;
        max-height: 220px;
        overflow: auto;
      }

      @media (min-width: 981px) {
        .brand__tag {
          display: none;
        }

        .ai-quickbar__inner {
          flex-wrap: nowrap;
          overflow-x: auto;
          scrollbar-width: none;
          -webkit-overflow-scrolling: touch;
        }

        .ai-quickbar__inner::-webkit-scrollbar {
          display: none;
        }

        .ai-quickbar__label {
          display: none;
        }
      }

      @media (min-width: 1040px) {
        .concierge-grid {
          grid-template-columns: 1.1fr 0.9fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="container header__inner">
        <a class="brand" href="homepage.html" aria-label="Atlas Masa home">
          <span class="brand__mark" aria-hidden="true">
            <svg viewBox="0 0 64 64" width="28" height="28" role="img" focusable="false">
              <path d="M10 46c6-10 14-22 22-28 8 6 16 18 22 28" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
              <path d="M14 46h36" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
              <path d="M32 10v12" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
              <path d="M26 22h12" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            </svg>
          </span>
          <span class="brand__text">
            <span class="brand__name">אטלס מסע</span>
            <span class="brand__tag">AI Studio</span>
          </span>
        </a>
        <nav class="nav nav--desktop" aria-label="Primary navigation">
          <a href="homepage.html" data-i18n="studio.nav.home">דף הבית</a>
          <a href="pricing.html" data-i18n="studio.nav.pricing">חבילות</a>
          <a href="vans-company-future.html" data-i18n="studio.nav.theory">תיאוריה</a>
          <a href="contact.html" data-i18n="studio.nav.contact">צור קשר</a>
          <a class="nav__auth" href="signin.html" data-i18n="studio.nav.login">התחברות</a>
          <a class="nav__auth nav__auth--primary" href="signup.html" data-i18n="studio.nav.signup">הרשמה</a>
        </nav>
        <details class="nav nav--mobile">
          <summary aria-label="פתח תפריט">תפריט</summary>
          <div class="nav__panel" role="navigation" aria-label="Mobile navigation">
            <a href="homepage.html" data-i18n="studio.nav.home">דף הבית</a>
            <a href="pricing.html" data-i18n="studio.nav.pricing">חבילות</a>
            <a href="vans-company-future.html" data-i18n="studio.nav.theory">תיאוריה</a>
            <a href="contact.html" data-i18n="studio.nav.contact">צור קשר</a>
            <a href="signin.html" data-i18n="studio.nav.login">התחברות</a>
            <a href="signup.html" data-i18n="studio.nav.signup">הרשמה</a>
          </div>
        </details>
      </div>
      <section class="ai-quickbar" aria-label="AI quick start" data-i18n-aria-label="studio.quickAria">
        <div class="container ai-quickbar__inner" id="launch-bar">
          <span class="ai-quickbar__label" data-i18n="studio.quickLabel">התחלה מהירה עם AI:</span>
          <button class="ai-quickbar__item" type="button" data-launch="chat" data-i18n="studio.quick.chat">צ׳אט טקסט</button>
          <button class="ai-quickbar__item" type="button" data-launch="trip" data-i18n="studio.quick.trip">תכנון מסלול</button>
          <button class="ai-quickbar__item" type="button" data-launch="voice" data-i18n="studio.quick.voice">צ׳ק-אין קולי</button>
          <button class="ai-quickbar__item" type="button" data-launch="survey" data-i18n="studio.quick.survey">סקר עומק</button>
          <button class="ai-quickbar__item" type="button" data-launch="notes" data-i18n="studio.quick.notes">לכידת פתקים</button>
          <button class="ai-quickbar__item" type="button" data-launch="memory" data-i18n="studio.quick.memory">ייבוא זיכרון</button>
          <button class="ai-quickbar__item" type="button" data-launch="feed" data-i18n="studio.quick.feed">פיד יזום</button>
          <button class="ai-quickbar__item" type="button" data-launch="login" data-i18n="studio.quick.login">התחברות</button>
          <button class="ai-quickbar__item" type="button" data-launch="signup" data-i18n="studio.quick.signup">הרשמה</button>
        </div>
      </section>
    </header>
    <main class="section">
      <div class="container concierge-app">
        <div class="section__head">
          <span class="pill" data-i18n="studio.pill">Atlas Masa AI</span>
          <h1 data-i18n="studio.title">סטודיו AI לניהול חיים, עבודה ותנועה</h1>
          <p class="sub" data-i18n="studio.sub">
            הקונסיירז׳ הוא רק פיצ׳ר אחד: זו מערכת אישית שמארגנת ביצוע, שומרת זיכרון ארוך-טווח,
            ומספקת פיד יזום כדי לקדם אותך ביום-יום.
          </p>
        </div>

        <section class="concierge-grid">
          <article class="card panel">
            <h2 data-i18n="studio.featureTitle">איזה פיצ׳ר מפעילים עכשיו?</h2>
            <div class="segment" id="feature-segment">
              <button class="chip" data-feature="concierge" aria-pressed="true" type="button" data-i18n="studio.feature.concierge">קונסיירז׳</button>
              <button class="chip" data-feature="studio" aria-pressed="false" type="button" data-i18n="studio.feature.studio">סטודיו תשובות</button>
              <button class="chip" data-feature="survey" aria-pressed="false" type="button" data-i18n="studio.feature.survey">סקר עומק מותאם</button>
              <button class="chip" data-feature="feed" aria-pressed="false" type="button" data-i18n="studio.feature.feed">פיד יזום</button>
            </div>

            <div class="survey-card" style="margin-top:12px">
              <p id="service-status" class="muted-line" data-i18n="studio.statusChecking">בודקים חיבור לשירות...</p>
              <p id="voice-status" class="voice-state" data-i18n="studio.voiceReady">מצב קולי: מוכן</p>
              <p id="active-locale-label" class="muted-line" data-i18n="studio.locale">שפת שירות: עברית</p>
            </div>

            <div class="survey-card" style="margin-top:10px">
              <h3 data-i18n="studio.authTitle">גישה מאובטחת לחשבון</h3>
              <p id="user-status" class="subtle" data-i18n="studio.authGuest">לא מחוברים. מומלץ להתחבר כדי לשמור זיכרון ארוך-טווח.</p>
              <div class="actions">
                <a class="btn btn--ghost" href="signin.html" data-i18n="studio.authPortalSignin">Passwordless (more secure) Sign in</a>
                <a class="btn btn--ghost" href="signup.html" data-i18n="studio.authPortalSignup">Passwordless (more secure) Sign up</a>
                <button class="btn btn--primary" id="subscribe-monthly" type="button" data-i18n="studio.subscribeMonthly">מנוי חודשי (Apple Pay)</button>
                <button class="btn btn--ghost" id="signout-btn" type="button" data-i18n="studio.authSignout" style="display:none">התנתקות</button>
              </div>
              <p class="muted-line" data-i18n="studio.profileSurveyNote">
                העדפת סגנון מסע נאספת דרך סקר העומק המותאם.
              </p>
              <div class="actions">
                <button class="btn btn--ghost" id="save-profile-btn" type="button" data-i18n="studio.saveProfile">שמירת פרופיל</button>
              </div>
            </div>

            <section class="feature-block active" id="feature-concierge">
              <div class="field">
                <label data-i18n="studio.modeLabel">מצב קונסיירז׳</label>
                <div class="segment" id="mode-segment">
                  <button class="chip" data-mode="chat" aria-pressed="true" type="button" data-i18n="studio.mode.chat">שאלה כללית</button>
                  <button class="chip" data-mode="trip" aria-pressed="false" type="button" data-i18n="studio.mode.trip">תכנון מסלול</button>
                  <button class="chip" data-mode="health" aria-pressed="false" type="button" data-i18n="studio.mode.health">בדיקת מערכת</button>
                </div>
              </div>

              <div class="field">
                <label data-i18n="studio.suggestions">הצעות פרומפט</label>
                <div class="segment" id="suggestions-segment"></div>
              </div>

              <div class="field" id="trip-fields" style="display:none">
                <label data-i18n="studio.tripStyle">סגנון מסלול</label>
                <div class="segment" id="style-segment">
                  <button class="chip" data-style="beach" aria-pressed="true" type="button">beach</button>
                  <button class="chip" data-style="north" aria-pressed="false" type="button">north</button>
                  <button class="chip" data-style="desert" aria-pressed="false" type="button">desert</button>
                  <button class="chip" data-style="mixed" aria-pressed="false" type="button">mixed</button>
                </div>
              </div>

              <div class="field">
                <label for="message" data-i18n="studio.promptLabel">מה תרצה לשאול או לקדם עכשיו?</label>
                <textarea id="message" data-i18n-placeholder="studio.promptPh" placeholder="לדוגמה: תן לי תוכנית עבודה ומסלול יומי שידחוף ביצוע"></textarea>
              </div>

              <div class="actions">
                <button class="btn btn--primary" id="send-btn" type="button" data-i18n="studio.send">שלח</button>
                <button class="btn btn--ghost" id="voice-btn" type="button" data-i18n="studio.voiceInput">קלט קולי</button>
                <button class="btn btn--ghost" id="speak-btn" type="button" data-i18n="studio.speak">הקראה</button>
                <a class="btn btn--ghost" href="homepage.html" data-i18n="studio.back">חזרה לדף הבית</a>
              </div>
            </section>

            <section class="feature-block" id="feature-studio">
              <div class="field">
                <label for="preferred-format" data-i18n="studio.format">פורמט תשובה מועדף (סטודיו)</label>
                <select id="preferred-format">
                  <option value="structured_plan">Structured Plan</option>
                  <option value="checklist">Checklist</option>
                  <option value="step_by_step">Step by Step</option>
                  <option value="timeline">Timeline</option>
                  <option value="concise">Concise</option>
                  <option value="notebook_style">Notebook-style</option>
                  <option value="json">JSON</option>
                </select>
              </div>

              <div class="field">
                <label for="response-depth" data-i18n="studio.depth">עומק תשובה</label>
                <select id="response-depth">
                  <option value="quick">quick</option>
                  <option value="balanced">balanced</option>
                  <option value="deep">deep</option>
                </select>
              </div>

              <div class="field">
                <label for="response-tone" data-i18n="studio.tone">סגנון ליווי</label>
                <select id="response-tone">
                  <option value="coach">coach</option>
                  <option value="direct">direct</option>
                  <option value="calm">calm</option>
                  <option value="strategic">strategic</option>
                  <option value="executive" selected>executive</option>
                </select>
              </div>

              <div class="field">
                <label for="proactive-mode" data-i18n="studio.proactiveMode">פלט יזום ללא פרומפט</label>
                <select id="proactive-mode">
                  <option value="enabled">enabled</option>
                  <option value="focus_only">focus_only</option>
                  <option value="disabled">disabled</option>
                </select>
              </div>

              <div class="field">
                <label for="reminders-app" data-i18n="studio.remindersApp">אפליקציית תזכורות מועדפת</label>
                <select id="reminders-app">
                  <option value="google_calendar">Google Calendar</option>
                  <option value="apple_reminders">Apple Reminders</option>
                  <option value="shortcuts">Apple Shortcuts</option>
                  <option value="todoist">Todoist</option>
                  <option value="notion">Notion</option>
                </select>
              </div>

              <div class="field">
                <label for="alarms-app" data-i18n="studio.alarmsApp">אפליקציית אזעקות מועדפת</label>
                <select id="alarms-app">
                  <option value="apple_clock">Apple Clock</option>
                  <option value="google_clock">Google Clock</option>
                  <option value="shortcuts">Apple Shortcuts</option>
                </select>
              </div>

              <div class="field">
                <label for="voice-mode" data-i18n="studio.voiceMode">מצב שיחה קולית</label>
                <select id="voice-mode">
                  <option value="enabled">enabled</option>
                  <option value="disabled">disabled</option>
                </select>
              </div>

              <div class="field">
                <label for="note-title" data-i18n="studio.noteTitle">כותרת פתק</label>
                <input id="note-title" placeholder="Mission note" />
              </div>
              <div class="field">
                <label for="note-content" data-i18n="studio.noteContent">תוכן פתק</label>
                <textarea id="note-content" data-i18n-placeholder="studio.noteContentPh" placeholder="מה צריך לקרות היום, בחודש הקרוב, ובתמונה הגדולה?"></textarea>
              </div>
              <div class="actions">
                <button class="btn btn--ghost" id="save-note-btn" type="button" data-i18n="studio.saveNote">שמירת פתק</button>
                <button class="btn btn--ghost" id="rewrite-note-btn" type="button" data-i18n="studio.rewriteNote">שכתוב יוקרתי עם AI</button>
                <button class="btn btn--ghost" id="load-notes-btn" type="button" data-i18n="studio.loadNotes">טעינת פתקים</button>
              </div>
              <div class="field">
                <label for="memory-import-json" data-i18n="studio.memoryImportLabel">ייבוא זיכרון JSON (Notebooks/Threads)</label>
                <textarea
                  id="memory-import-json"
                  data-i18n-placeholder="studio.memoryImportPh"
                  placeholder='{"items":[{"title":"Trip pattern","content":"...","tags":["north"],"source":"notebooklm"}]}'
                ></textarea>
              </div>
              <div class="actions">
                <button class="btn btn--ghost" id="import-memory-btn" type="button" data-i18n="studio.importMemory">ייבוא לזיכרון ארוך-טווח</button>
              </div>

              <div class="actions">
                <button class="btn btn--primary" id="save-studio-btn" type="button" data-i18n="studio.saveStudio">שמירת הגדרות סטודיו</button>
                <button class="btn btn--ghost" id="load-studio-btn" type="button" data-i18n="studio.loadStudio">טעינת הגדרות</button>
              </div>
            </section>

            <section class="feature-block" id="feature-survey">
              <p class="subtle" data-i18n="studio.surveySub">
                סקר עומק מותאם בזמן אמת. כל תשובה משנה את השאלה הבאה ואת המלצות המערכת.
              </p>
              <div class="survey-progress" aria-hidden="true"><span id="survey-progress-bar"></span></div>
              <p class="muted-line" id="survey-progress-text">0%</p>

              <div class="field" id="survey-question-field">
                <label id="survey-question">טוען שאלה...</label>
                <p id="survey-description" class="muted-line"></p>
                <div class="segment" id="survey-choices"></div>
                <input id="survey-free-answer" style="display:none" />
              </div>

              <div class="actions">
                <button class="btn btn--ghost" id="survey-next-btn" type="button" data-i18n="studio.surveyNext">המשך</button>
                <button class="btn btn--ghost" id="survey-voice-btn" type="button" data-i18n="studio.surveyVoice">תשובה קולית</button>
              </div>

              <div class="field">
                <label data-i18n="studio.feedbackLabel">פידבק לצוות (מנותב ליָשה כברירת מחדל)</label>
                <textarea id="feedback-message" data-i18n-placeholder="studio.feedbackPh" placeholder="מה חסר לך כדי לתפקד טוב יותר ביום-יום?"></textarea>
              </div>
              <div class="actions">
                <button class="btn btn--ghost" id="send-feedback-btn" type="button" data-i18n="studio.sendFeedback">שליחת פידבק</button>
              </div>
            </section>

            <section class="feature-block" id="feature-feed">
              <p class="subtle" data-i18n="studio.feedSub">
                פיד יזום שמניע ביצוע: משימות יומיות, תזכורות, אזעקות ועדכוני חברה.
              </p>
              <div class="actions">
                <button class="btn btn--primary" id="refresh-feed-btn" type="button" data-i18n="studio.refreshFeed">רענון פיד</button>
              </div>
              <div class="stack" id="feed-list"></div>
            </section>

            <details class="debug" id="debug-controls" style="display:none">
              <summary>Debug</summary>
              <div class="field">
                <label for="api-base">API Base</label>
                <input id="api-base" value="" />
              </div>
              <div class="field">
                <label for="api-key">API Key</label>
                <input id="api-key" value="dev-atlas-key" />
              </div>
              <div class="raw" id="debug-raw">-</div>
            </details>
          </article>

          <article class="card panel">
            <h2 data-i18n="studio.outputTitle">פלט מערכת</h2>
            <div class="output" id="output-box" data-i18n="studio.outputReady">
              המערכת מוכנה. התחילו עם שאלה, סקר, או פיד יזום.
            </div>
            <div class="tag-row" id="tag-row"></div>
            <div class="action-list" id="action-list"></div>

            <div class="survey-card" style="margin-top:12px">
              <h3 data-i18n="studio.autoTitle">מה המערכת עושה אוטומטית?</h3>
              <div class="pill-line">
                <span class="tag" data-i18n="studio.auto1">תשובות מותאמות לפרופיל</span>
                <span class="tag" data-i18n="studio.auto2">פיד יזום לפי עומס יומי</span>
                <span class="tag" data-i18n="studio.auto3">הצעות תזכורת ואזעקה</span>
                <span class="tag" data-i18n="studio.auto4">איסוף פידבק ורוטינג לצוות</span>
              </div>
            </div>
          </article>
        </section>
      </div>
    </main>

    <script>
      window.ATLAS_PAGE_I18N = {
        he: {
          meta: {
            title: "Atlas Masa AI Studio | אטלס מסע",
            description:
              "מערכת AI אישית לניידות, עבודה וחיים: קונסיירז', סטודיו תשובות, סקר מותאם בזמן אמת ופיד יזום.",
          },
          studio: {
            nav: {
              home: "דף הבית",
              pricing: "חבילות",
              theory: "תיאוריה",
              contact: "צור קשר",
              login: "התחברות",
              signup: "הרשמה",
            },
            pill: "Atlas Masa AI",
            title: "סטודיו AI לניהול חיים, עבודה ותנועה",
            sub: "הקונסיירז׳ הוא רק פיצ׳ר אחד: זו מערכת אישית שמארגנת ביצוע, שומרת זיכרון ארוך-טווח, ומספקת פיד יזום כדי לקדם אותך ביום-יום.",
            featureTitle: "איזה פיצ׳ר מפעילים עכשיו?",
            feature: {
              concierge: "קונסיירז׳",
              studio: "סטודיו תשובות",
              survey: "סקר עומק מותאם",
              feed: "פיד יזום",
            },
            quickAria: "התחלה מהירה לפיצ׳רי AI",
            quickLabel: "התחלה מהירה עם AI:",
            quick: {
              chat: "צ׳אט טקסט",
              trip: "תכנון מסלול",
              voice: "צ׳ק-אין קולי",
              survey: "סקר עומק",
              notes: "לכידת פתקים",
              memory: "ייבוא זיכרון",
              feed: "פיד יזום",
              login: "התחברות",
              signup: "הרשמה",
            },
            statusChecking: "בודקים חיבור לשירות...",
            voiceReady: "מצב קולי: מוכן",
            voiceTapPrompt: "לחצו על כפתור הקלט הקולי כדי להתחיל צ׳ק-אין קולי.",
            loginPrompt: "נפתח עמוד התחברות מאובטח ללא סיסמה.",
            signupPrompt: "נפתח עמוד הרשמה מאובטח ללא סיסמה.",
            locale: "שפת שירות",
            authTitle: "גישה מאובטחת לחשבון",
            authGuest: "לא מחוברים. מומלץ להתחבר כדי לשמור זיכרון ארוך-טווח.",
            authPortalSignin: "Passwordless (more secure) Sign in",
            authPortalSignup: "Passwordless (more secure) Sign up",
            authGoogle: "כניסה עם Google",
            authApple: "כניסה עם Apple",
            authPasskey: "כניסה עם Passkey",
            authPasskeyEnroll: "הרשמה עם Passkey",
            subscribeMonthly: "מנוי חודשי (Apple Pay)",
            authSignout: "התנתקות",
            profileSurveyNote: "העדפת סגנון מסע נאספת דרך סקר העומק המותאם.",
            saveProfile: "שמירת פרופיל",
            modeLabel: "מצב קונסיירז׳",
            mode: {
              chat: "שאלה כללית",
              trip: "תכנון מסלול",
              health: "בדיקת מערכת",
            },
            suggestions: "הצעות פרומפט",
            tripStyle: "סגנון מסלול",
            promptLabel: "מה תרצה לשאול או לקדם עכשיו?",
            promptPh: "לדוגמה: תן לי תוכנית עבודה ומסלול יומי שידחוף ביצוע",
            send: "שלח",
            voiceInput: "קלט קולי",
            speak: "הקראה",
            back: "חזרה לדף הבית",
            format: "פורמט תשובה מועדף (סטודיו)",
            depth: "עומק תשובה",
            tone: "סגנון ליווי",
            proactiveMode: "פלט יזום ללא פרומפט",
            remindersApp: "אפליקציית תזכורות מועדפת",
            alarmsApp: "אפליקציית אזעקות מועדפת",
            voiceMode: "מצב שיחה קולית",
            noteTitle: "כותרת פתק",
            noteContent: "תוכן פתק",
            noteContentPh: "מה צריך לקרות היום, בחודש הקרוב, ובתמונה הגדולה?",
            saveNote: "שמירת פתק",
            rewriteNote: "שכתוב יוקרתי עם AI",
            loadNotes: "טעינת פתקים",
            memoryImportLabel: "ייבוא זיכרון JSON (Notebooks/Threads)",
            memoryImportPh: "הדביקו JSON עם items כדי להאכיל את זיכרון המערכת לטווח ארוך.",
            importMemory: "ייבוא לזיכרון ארוך-טווח",
            saveStudio: "שמירת הגדרות סטודיו",
            loadStudio: "טעינת הגדרות",
            surveySub: "סקר עומק מותאם בזמן אמת. כל תשובה משנה את השאלה הבאה ואת המלצות המערכת.",
            surveyNext: "המשך",
            surveyVoice: "תשובה קולית",
            feedbackLabel: "פידבק לצוות (מנותב ליָשה כברירת מחדל)",
            feedbackPh: "מה חסר לך כדי לתפקד טוב יותר ביום-יום?",
            sendFeedback: "שליחת פידבק",
            feedSub: "פיד יזום שמניע ביצוע: משימות יומיות, תזכורות, אזעקות ועדכוני חברה.",
            refreshFeed: "רענון פיד",
            outputTitle: "פלט מערכת",
            outputReady: "המערכת מוכנה. התחילו עם שאלה, סקר, או פיד יזום.",
            autoTitle: "מה המערכת עושה אוטומטית?",
            auto1: "תשובות מותאמות לפרופיל",
            auto2: "פיד יזום לפי עומס יומי",
            auto3: "הצעות תזכורת ואזעקה",
            auto4: "איסוף פידבק ורוטינג לצוות",
          },
        },
        en: {
          meta: {
            title: "Atlas Masa AI Studio",
            description:
              "Personal AI for movement, work, and life: concierge, response studio, adaptive survey, and proactive feed.",
          },
          studio: {
            nav: {
              home: "Homepage",
              pricing: "Pricing",
              theory: "Theory",
              contact: "Contact",
              login: "Log in",
              signup: "Sign up",
            },
            pill: "Atlas Masa AI",
            title: "AI Studio for Life, Work, and Mobility",
            sub: "Concierge is only one feature. This system builds long-term memory, proactive outputs, and daily execution support.",
            featureTitle: "Which feature do you want now?",
            feature: {
              concierge: "Concierge",
              studio: "Response Studio",
              survey: "Adaptive Deep Survey",
              feed: "Proactive Feed",
            },
            quickAria: "Quick launch AI features",
            quickLabel: "AI quick start:",
            quick: {
              chat: "Text chat",
              trip: "Trip planning",
              voice: "Voice check-in",
              survey: "Deep survey",
              notes: "Notes capture",
              memory: "Memory import",
              feed: "Proactive feed",
              login: "Log in",
              signup: "Sign up",
            },
            statusChecking: "Checking service connection...",
            voiceReady: "Voice: ready",
            voiceTapPrompt: "Tap the voice input button to start a voice check-in.",
            loginPrompt: "Opening secure passwordless sign-in page.",
            signupPrompt: "Opening secure passwordless sign-up page.",
            locale: "Service language",
            authTitle: "Secure account access",
            authGuest: "Not signed in. Sign in to unlock long-term memory.",
            authPortalSignin: "Passwordless (more secure) Sign in",
            authPortalSignup: "Passwordless (more secure) Sign up",
            authGoogle: "Sign in with Google",
            authApple: "Sign in with Apple",
            authPasskey: "Sign in with Passkey",
            authPasskeyEnroll: "Sign up with Passkey",
            subscribeMonthly: "Monthly subscription (Apple Pay)",
            authSignout: "Sign out",
            profileSurveyNote: "Trip style preference is captured in the adaptive deep survey.",
            saveProfile: "Save profile",
            modeLabel: "Concierge mode",
            mode: { chat: "General question", trip: "Plan trip", health: "System health" },
            suggestions: "Prompt suggestions",
            tripStyle: "Trip style",
            promptLabel: "What do you want to ask or move forward now?",
            promptPh: "Example: give me an execution plan and daily route rhythm",
            send: "Send",
            voiceInput: "Voice input",
            speak: "Speak output",
            back: "Back to homepage",
            format: "Preferred response format",
            depth: "Response depth",
            tone: "Coaching tone",
            proactiveMode: "Unprompted proactive output",
            remindersApp: "Preferred reminders app",
            alarmsApp: "Preferred alarms app",
            voiceMode: "Voice conversation mode",
            noteTitle: "Note title",
            noteContent: "Note content",
            noteContentPh: "What must happen today, mid-term, and in the big picture?",
            saveNote: "Save note",
            rewriteNote: "Rewrite with AI",
            loadNotes: "Load notes",
            memoryImportLabel: "Import memory JSON (Notebooks/Threads)",
            memoryImportPh: "Paste JSON with items to feed long-term system memory.",
            importMemory: "Import into long-term memory",
            saveStudio: "Save studio settings",
            loadStudio: "Load settings",
            surveySub: "Adaptive deep survey in real-time. Every answer changes what comes next.",
            surveyNext: "Next",
            surveyVoice: "Voice answer",
            feedbackLabel: "Feedback to team (routed to Yasha by default)",
            feedbackPh: "What are you missing to function better daily?",
            sendFeedback: "Send feedback",
            feedSub: "Proactive feed for execution: daily actions, reminders, alarms, and company updates.",
            refreshFeed: "Refresh feed",
            outputTitle: "System output",
            outputReady: "System is ready. Start with a prompt, survey, or proactive feed.",
            autoTitle: "What runs automatically?",
            auto1: "Profile-tailored responses",
            auto2: "Proactive feed by daily pressure",
            auto3: "Reminder/alarm suggestions",
            auto4: "Feedback collection and team routing",
          },
        },
      };
    </script>
    <script src="sitewide-language.js"></script>
    <script>
      const state = {
        locale: "he",
        feature: "concierge",
        mode: "chat",
        user: null,
        capabilities: {
          google_oauth: true,
          apple_oauth: true,
          passkey: true,
          billing: true,
          deep_personalization: true,
        },
        subscription: {
          bypass: false,
          active: false,
          tier: "standard",
        },
        style: "beach",
        survey: {
          question: null,
          selected: null,
          localMode: false,
          localAnswers: {},
          progress: { percent: 0, answered: 0, total: 0 },
        },
        studio: {
          preferred_format: "structured_plan",
          response_depth: "deep",
          response_tone: "executive",
          proactive_mode: "enabled",
          reminders_app: "google_calendar",
          alarms_app: "apple_clock",
          voice_mode: "enabled",
        },
        proactiveItems: [],
        notes: [],
        activeNoteId: null,
        lastOutput: "",
        listening: false,
      };

      const featureSegment = document.getElementById("feature-segment");
      const modeSegment = document.getElementById("mode-segment");
      const styleSegment = document.getElementById("style-segment");
      const suggestionsSegment = document.getElementById("suggestions-segment");
      const tripFields = document.getElementById("trip-fields");
      const messageEl = document.getElementById("message");
      const sendBtn = document.getElementById("send-btn");
      const voiceBtn = document.getElementById("voice-btn");
      const speakBtn = document.getElementById("speak-btn");
      const outputBox = document.getElementById("output-box");
      const tagRow = document.getElementById("tag-row");
      const actionList = document.getElementById("action-list");
      const launchBar = document.getElementById("launch-bar");
      const serviceStatus = document.getElementById("service-status");
      const activeLocaleLabel = document.getElementById("active-locale-label");
      const voiceStatus = document.getElementById("voice-status");
      const userStatus = document.getElementById("user-status");
      const googleSigninBtn = document.getElementById("google-signin");
      const appleSigninBtn = document.getElementById("apple-signin");
      const passkeySigninBtn = document.getElementById("passkey-signin");
      const passkeyEnrollBtn = document.getElementById("passkey-enroll");
      const subscribeMonthlyBtn = document.getElementById("subscribe-monthly");
      const signoutBtn = document.getElementById("signout-btn");
      const saveProfileBtn = document.getElementById("save-profile-btn");
      const surveyQuestion = document.getElementById("survey-question");
      const surveyDescription = document.getElementById("survey-description");
      const surveyChoices = document.getElementById("survey-choices");
      const surveyProgressBar = document.getElementById("survey-progress-bar");
      const surveyProgressText = document.getElementById("survey-progress-text");
      const surveyNextBtn = document.getElementById("survey-next-btn");
      const surveyVoiceBtn = document.getElementById("survey-voice-btn");
      const feedbackMessage = document.getElementById("feedback-message");
      const sendFeedbackBtn = document.getElementById("send-feedback-btn");
      const refreshFeedBtn = document.getElementById("refresh-feed-btn");
      const feedList = document.getElementById("feed-list");
      const saveStudioBtn = document.getElementById("save-studio-btn");
      const loadStudioBtn = document.getElementById("load-studio-btn");
      const preferredFormat = document.getElementById("preferred-format");
      const responseDepth = document.getElementById("response-depth");
      const responseTone = document.getElementById("response-tone");
      const proactiveMode = document.getElementById("proactive-mode");
      const remindersApp = document.getElementById("reminders-app");
      const alarmsApp = document.getElementById("alarms-app");
      const voiceMode = document.getElementById("voice-mode");
      const noteTitle = document.getElementById("note-title");
      const noteContent = document.getElementById("note-content");
      const saveNoteBtn = document.getElementById("save-note-btn");
      const rewriteNoteBtn = document.getElementById("rewrite-note-btn");
      const loadNotesBtn = document.getElementById("load-notes-btn");
      const memoryImportJson = document.getElementById("memory-import-json");
      const importMemoryBtn = document.getElementById("import-memory-btn");
      const apiBaseInput = document.getElementById("api-base");
      const apiKeyInput = document.getElementById("api-key");
      const debugRaw = document.getElementById("debug-raw");

      const QUICK_PROMPTS = {
        chat: {
          he: [
            "תן לי תוכנית ביצוע ליום עמוס עם תזכורות ואזהרות מראש.",
            "איך אני מתקדם כלכלית ועדיין שומר על בריאות ושקט?",
            "בנה לי שגרת עבודה בתנועה בלי להישרף.",
          ],
          en: [
            "Build me a high-pressure execution plan with reminders and risk alerts.",
            "How do I grow financially while protecting health and focus?",
            "Design a movement-first workday routine without burnout.",
          ],
        },
        trip: {
          he: ["סופ״ש חופים", "צפון ירוק", "מסלול מדברי חכם"],
          en: ["beach weekend", "north green", "smart desert route"],
        },
      };

      let recognition = null;
      const NEGATIVE_SIGNAL_PATTERNS = [
        "frustrat",
        "angry",
        "upset",
        "stuck",
        "hate",
        "not working",
        "broken",
        "terrible",
        "awful",
        "bad",
        "can't",
        "cannot",
        "לא עובד",
        "לא עובדת",
        "לא מצליח",
        "לא מצליחה",
        "תקוע",
        "מתוסכל",
        "מתוסכלת",
        "נמאס",
        "גרוע",
        "שבור",
      ];

      function getByPath(objectValue, path) {
        if (!objectValue || !path) return undefined;
        return path.split(".").reduce((acc, key) => {
          if (acc && Object.prototype.hasOwnProperty.call(acc, key)) return acc[key];
          return undefined;
        }, objectValue);
      }

      function t(path) {
        const all = window.ATLAS_PAGE_I18N || {};
        const current = getByPath(all[state.locale] || all.he || {}, path);
        if (current !== undefined && current !== null) return current;
        const fallback = getByPath(all.he || {}, path);
        return fallback !== undefined ? fallback : path;
      }

      function getSiteLocale() {
        if (window.AtlasLanguage && typeof window.AtlasLanguage.getCurrent === "function") {
          return window.AtlasLanguage.getCurrent();
        }
        return document.documentElement.getAttribute("lang") || "he";
      }

      function inferApiBase() {
        const host = window.location.hostname;
        if (host === "localhost" || host === "127.0.0.1") return "http://localhost:8080";
        if (host === "atlasmasa.com" || host === "www.atlasmasa.com") return window.location.origin;
        return `${window.location.protocol}//${host}:8080`;
      }

      function normalizeApiBase(value) {
        return String(value || "").trim().replace(/\/+$/, "");
      }

      function getApiBaseCandidates() {
        const params = new URLSearchParams(window.location.search);
        const fromQuery = params.get("api_base");
        const fromWindow =
          typeof window.ATLAS_API_BASE === "string" ? window.ATLAS_API_BASE : "";
        let fromStorage = "";
        try {
          fromStorage = window.localStorage.getItem("atlas_api_base") || "";
        } catch (_) {
          fromStorage = "";
        }
        const host = window.location.hostname;
        const isProdDomain = host === "atlasmasa.com" || host === "www.atlasmasa.com";
        const candidates = [
          apiBaseInput && apiBaseInput.value ? apiBaseInput.value : "",
          fromQuery,
          fromWindow,
          fromStorage,
          isProdDomain ? "https://api.atlasmasa.com" : "",
          inferApiBase(),
        ]
          .map(normalizeApiBase)
          .filter(Boolean);

        if (host === "atlasmasa.com" || host === "www.atlasmasa.com") {
          candidates.push(window.location.origin);
        }

        return [...new Set(candidates)];
      }

      function setPressed(container, key, value) {
        container.querySelectorAll(`button[data-${key}]`).forEach((button) => {
          button.setAttribute("aria-pressed", button.dataset[key] === value ? "true" : "false");
        });
      }

      function renderLocaleLabel() {
        activeLocaleLabel.textContent = `${t("studio.locale")}: ${state.locale}`;
      }

      function setFeatureAvailability(button, enabled, reason) {
        if (!button) return;
        button.disabled = !enabled;
        button.style.opacity = enabled ? "1" : "0.56";
        button.style.cursor = enabled ? "pointer" : "not-allowed";
        button.title = enabled ? "" : reason;
      }

      function applyCapabilityGates() {
        const caps = state.capabilities || {};
        const authUnavailableMessage =
          state.locale === "he"
            ? "הפיצ׳ר לא מוגדר כרגע בשרת."
            : "This feature is not configured on the API server yet.";

        setFeatureAvailability(
          googleSigninBtn,
          !!caps.google_oauth,
          authUnavailableMessage
        );
        setFeatureAvailability(
          appleSigninBtn,
          !!caps.apple_oauth,
          authUnavailableMessage
        );
        setFeatureAvailability(
          passkeySigninBtn,
          !!caps.passkey,
          authUnavailableMessage
        );
        setFeatureAvailability(
          passkeyEnrollBtn,
          !!caps.passkey,
          authUnavailableMessage
        );
        setFeatureAvailability(
          subscribeMonthlyBtn,
          !!caps.billing,
          authUnavailableMessage
        );
      }

      function renderFeature() {
        setPressed(featureSegment, "feature", state.feature);
        document.querySelectorAll(".feature-block").forEach((block) => {
          block.classList.remove("active");
        });
        const target = document.getElementById(`feature-${state.feature}`);
        if (target) target.classList.add("active");
      }

      function renderMode() {
        setPressed(modeSegment, "mode", state.mode);
        tripFields.style.display = state.mode === "trip" ? "block" : "none";
        renderPromptSuggestions();
      }

      function renderPromptSuggestions() {
        const mode = state.mode === "trip" ? "trip" : "chat";
        const prompts = (QUICK_PROMPTS[mode] && (QUICK_PROMPTS[mode][state.locale] || QUICK_PROMPTS[mode].he)) || [];
        suggestionsSegment.innerHTML = "";

        prompts.forEach((prompt, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "chip";
          btn.textContent = prompt;
          btn.addEventListener("click", () => {
            if (state.mode === "trip") {
              state.style = idx === 0 ? "beach" : idx === 1 ? "north" : "desert";
              setPressed(styleSegment, "style", state.style);
            } else {
              messageEl.value = prompt;
            }
          });
          suggestionsSegment.appendChild(btn);
        });
      }

      function renderOutput(text, tags = [], raw = null) {
        state.lastOutput = text || "";
        outputBox.textContent = text;
        tagRow.innerHTML = tags.map((tag) => `<span class="tag">${escapeHtml(tag)}</span>`).join("");
        if (debugRaw) {
          debugRaw.textContent = raw ? JSON.stringify(raw, null, 2) : "-";
        }
      }

      function renderActions(actions = []) {
        actionList.innerHTML = "";
        actions.forEach((action) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn--ghost";
          btn.textContent = action.label || action.action_type;
          btn.addEventListener("click", () => handleSuggestedAction(action));
          actionList.appendChild(btn);
        });
      }

      function renderFeed(items = []) {
        state.proactiveItems = items;
        feedList.innerHTML = "";

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "tile";
          empty.innerHTML = `<h4>אין כרגע פריטים יזומים</h4><p>רעננו פיד או השלימו סקר עומק.</p>`;
          feedList.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const tile = document.createElement("article");
          tile.className = "tile";
          const actions = (item.actions || [])
            .map(
              (a, idx) =>
                `<button class="btn btn--ghost" data-feed-action="${idx}" data-feed-id="${escapeHtml(item.id)}">${escapeHtml(a.label || a.action_type)}</button>`
            )
            .join(" ");
          tile.innerHTML = `
            <h4>${escapeHtml(item.title || "Feed item")}</h4>
            <p>${escapeHtml(item.summary || "")}</p>
            <p class="muted-line">${escapeHtml(item.why_now || "")}</p>
            <div class="actions">${actions}</div>
          `;
          tile.querySelectorAll("button[data-feed-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const index = Number(btn.getAttribute("data-feed-action") || "0");
              const action = (item.actions || [])[index];
              if (action) handleSuggestedAction(action);
            });
          });
          feedList.appendChild(tile);
        });
      }

      function renderSurvey(payload) {
        if (!payload) return;
        state.survey.question = payload.question || null;
        state.survey.localMode = !!payload.local_mode;
        state.survey.progress = payload.progress || { percent: 0, answered: 0, total: 0 };
        state.survey.selected = null;

        const progress = state.survey.progress;
        surveyProgressText.textContent = `${progress.percent || 0}% • ${progress.answered || 0}/${progress.total || 0}`;
        surveyProgressBar.style.width = `${progress.percent || 0}%`;

        if (!payload.question) {
          surveyQuestion.textContent = state.locale === "he" ? "הסקר הושלם" : "Survey completed";
          surveyDescription.textContent = state.locale === "he" ? "מעולה. המערכת משתמשת בזה להתאמה עמוקה." : "Great. This now powers deep personalization.";
          surveyChoices.innerHTML = "";
          return;
        }

        surveyQuestion.textContent = payload.question.title || "";
        surveyDescription.textContent = payload.question.description || "";
        surveyChoices.innerHTML = "";

        (payload.question.choices || []).forEach((choice) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "chip";
          btn.textContent = choice.label || choice.value;
          btn.setAttribute("aria-pressed", "false");
          btn.addEventListener("click", () => {
            state.survey.selected = choice.value;
            surveyChoices.querySelectorAll(".chip").forEach((chip) => chip.setAttribute("aria-pressed", "false"));
            btn.setAttribute("aria-pressed", "true");
          });
          surveyChoices.appendChild(btn);
        });
      }

      function syncStudioControls() {
        preferredFormat.value = state.studio.preferred_format;
        responseDepth.value = state.studio.response_depth;
        responseTone.value = state.studio.response_tone;
        proactiveMode.value = state.studio.proactive_mode;
        remindersApp.value = state.studio.reminders_app;
        alarmsApp.value = state.studio.alarms_app;
        voiceMode.value = state.studio.voice_mode;
      }

      function collectStudioControls() {
        state.studio.preferred_format = preferredFormat.value;
        state.studio.response_depth = responseDepth.value;
        state.studio.response_tone = responseTone.value;
        state.studio.proactive_mode = proactiveMode.value;
        state.studio.reminders_app = remindersApp.value;
        state.studio.alarms_app = alarmsApp.value;
        state.studio.voice_mode = voiceMode.value;
      }

      function applyLaunchPreset(launch, options = {}) {
        const preset = String(launch || "").trim().toLowerCase();
        if (!preset) return;

        const userGesture = !!options.userGesture;
        const shouldFocus = !options.skipFocus;

        if (preset === "chat") {
          state.feature = "concierge";
          state.mode = "chat";
          renderFeature();
          renderMode();
          if (shouldFocus) messageEl.focus();
          return;
        }

        if (preset === "trip") {
          state.feature = "concierge";
          state.mode = "trip";
          renderFeature();
          renderMode();
          if (shouldFocus) messageEl.focus();
          return;
        }

        if (preset === "voice") {
          state.feature = "concierge";
          state.mode = "chat";
          renderFeature();
          renderMode();
          if (shouldFocus) voiceBtn.focus();
          if (userGesture) {
            toggleVoiceInput();
          } else {
            renderOutput(t("studio.voiceTapPrompt"), ["voice", "quick-start"]);
          }
          return;
        }

        if (preset === "survey") {
          state.feature = "survey";
          renderFeature();
          loadSurveyNext();
          if (shouldFocus) surveyNextBtn.focus();
          return;
        }

        if (preset === "notes") {
          state.feature = "studio";
          renderFeature();
          if (shouldFocus) noteContent.focus();
          return;
        }

        if (preset === "memory") {
          state.feature = "studio";
          renderFeature();
          if (shouldFocus) memoryImportJson.focus();
          return;
        }

        if (preset === "login") {
          const target = `signin.html?api_base=${encodeURIComponent(getApiBase())}`;
          if (userGesture) {
            window.location.href = target;
            return;
          }
          renderOutput(t("studio.loginPrompt"), ["auth", "passwordless", "login"]);
          return;
        }

        if (preset === "signup") {
          const target = `signup.html?api_base=${encodeURIComponent(getApiBase())}`;
          if (userGesture) {
            window.location.href = target;
            return;
          }
          renderOutput(t("studio.signupPrompt"), ["auth", "passwordless", "signup"]);
          return;
        }

        if (preset === "feed") {
          state.feature = "feed";
          renderFeature();
          loadProactiveFeed();
          if (shouldFocus) refreshFeedBtn.focus();
        }
      }

      function updateUserState() {
        if (!state.user) {
          userStatus.textContent = t("studio.authGuest");
          signoutBtn.style.display = "none";
          subscribeMonthlyBtn.disabled = false;
          subscribeMonthlyBtn.style.opacity = "1";
          return;
        }

        const subscriptionTag = state.subscription && state.subscription.bypass
          ? state.locale === "he"
            ? "Founder Access"
            : "Founder Access"
          : state.subscription && state.subscription.active
          ? state.locale === "he"
            ? "Subscription Active"
            : "Subscription Active"
          : "";
        userStatus.textContent = `${state.user.name || state.user.email} • ${state.user.provider}${subscriptionTag ? ` • ${subscriptionTag}` : ""}`;
        signoutBtn.style.display = "inline-flex";
        const founderBypass = !!(state.subscription && state.subscription.bypass);
        subscribeMonthlyBtn.disabled = founderBypass;
        subscribeMonthlyBtn.style.opacity = founderBypass ? "0.62" : "1";
      }

      function escapeHtml(input) {
        return String(input || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function detectNegativeSignal(text) {
        const normalized = String(text || "").trim().toLowerCase();
        if (!normalized) return false;
        return NEGATIVE_SIGNAL_PATTERNS.some((pattern) => normalized.includes(pattern));
      }

      async function maybeOfferAutoReport(sourceText, sourceTag, severity = "high") {
        if (!state.user) return;
        if (!detectNegativeSignal(sourceText)) return;

        const promptText =
          state.locale === "he"
            ? "זיהינו סימן לתסכול. לשלוח דיווח קצר לצוות (ליָשה) כדי לשפר את המוצר?"
            : "We detected possible frustration. Send a short report to the team (Yasha) to improve the product?";
        if (!window.confirm(promptText)) return;

        const message = String(sourceText || "").trim().slice(0, 1200);
        const result = await request("/v1/feedback/submit", "POST", {
          category: "ux",
          severity,
          message,
          tags: ["auto-detected-negative", sourceTag],
          target_employee: "yasha",
          source: "concierge-auto-detect",
        });

        if (result.ok) {
          renderOutput(
            state.locale === "he"
              ? "דיווח נשלח לצוות לטיפול מהיר."
              : "Report sent to the team for rapid follow-up.",
            ["feedback", "auto-report", "yasha"],
            result.payload
          );
        }
      }

      async function request(path, method = "GET", body = null, includeKey = true) {
        const headers = {};
        const key = (apiKeyInput && apiKeyInput.value.trim()) || "dev-atlas-key";
        if (includeKey) headers["x-api-key"] = key;
        if (body) headers["content-type"] = "application/json";
        const bases = getApiBaseCandidates();
        const networkErrors = [];
        const serverFailures = [];
        let lastClientFailure = null;

        for (const base of bases) {
          try {
            const response = await fetch(base + path, {
              method,
              headers,
              body: body ? JSON.stringify(body) : undefined,
              credentials: "include",
            });

            const text = await response.text();
            let payload;
            try {
              payload = JSON.parse(text);
            } catch {
              payload = { raw: text };
            }

            const result = {
              ok: response.ok,
              status: response.status,
              payload,
              base,
            };
            if (response.ok) {
              return result;
            }

            if (response.status >= 500) {
              serverFailures.push(result);
              continue;
            }

            if (!lastClientFailure) {
              lastClientFailure = result;
            }
          } catch (error) {
            networkErrors.push({
              base,
              message: error && error.message ? error.message : String(error),
            });
          }
        }

        if (lastClientFailure) {
          return lastClientFailure;
        }

        if (serverFailures.length) {
          const last = serverFailures[serverFailures.length - 1];
          return {
            ok: false,
            status: last.status,
            payload: Object.assign({}, last.payload || {}, {
              error: (last.payload && last.payload.error) || "upstream_server_error",
              message:
                (last.payload && last.payload.message) ||
                "Upstream server error on all API candidates",
              candidates: bases,
              failures: serverFailures.map((failure) => ({
                base: failure.base,
                status: failure.status,
              })),
            }),
            base: last.base,
          };
        }

        return {
          ok: false,
          status: 0,
          payload: {
            error: "network_error",
            message: "All API base candidates failed",
            candidates: bases,
            failures: networkErrors,
          },
          base: null,
        };
      }

      async function runHealthCheck() {
        try {
          const result = await request("/health", "GET", null, false);
          if (result.ok) {
            const capabilities = result.payload && result.payload.capabilities ? result.payload.capabilities : {};
            state.capabilities = Object.assign({}, state.capabilities, capabilities);
            applyCapabilityGates();
            serviceStatus.textContent = state.locale === "he" ? "השירות פעיל" : "Service is online";
            serviceStatus.className = "status-ok";
          } else if (result.status === 0) {
            state.capabilities = Object.assign({}, state.capabilities, {
              google_oauth: true,
              apple_oauth: true,
              passkey: true,
              billing: true,
            });
            applyCapabilityGates();
            serviceStatus.textContent =
              state.locale === "he"
                ? "קישוריות חלקית לשרת. אפשר להמשיך בסקר מקומי ולנסות התחברות."
                : "Partial server connectivity. Continue in local survey mode and try sign-in.";
            serviceStatus.className = "status-warn";
          } else {
            state.capabilities = Object.assign({}, state.capabilities, {
              google_oauth: true,
              apple_oauth: true,
              passkey: true,
              billing: true,
            });
            applyCapabilityGates();
            serviceStatus.textContent =
              state.locale === "he"
                ? "קישוריות חלקית לשרת. חלק מהיכולות בענן זמניות לא יציבות."
                : "Partial server connectivity. Some cloud features are temporarily unstable.";
            serviceStatus.className = "status-warn";
          }
        } catch (error) {
          state.capabilities = Object.assign({}, state.capabilities, {
            google_oauth: true,
            apple_oauth: true,
            passkey: true,
            billing: true,
          });
          applyCapabilityGates();
          serviceStatus.textContent =
            state.locale === "he"
              ? "קישוריות חלקית לשרת. נסו שוב בעוד רגע."
              : "Partial server connectivity. Please retry in a moment.";
          serviceStatus.className = "status-warn";
        }
      }

      function getIdentityEmail() {
        return (
          state.user &&
          typeof state.user.email === "string" &&
          state.user.email.trim().length
            ? state.user.email.trim().toLowerCase()
            : ""
        );
      }

      function fromBase64Url(value) {
        const normalized = String(value || "").replace(/-/g, "+").replace(/_/g, "/");
        const padding = normalized.length % 4 ? "=".repeat(4 - (normalized.length % 4)) : "";
        const binary = atob(normalized + padding);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) bytes[i] = binary.charCodeAt(i);
        return bytes.buffer;
      }

      function toBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      }

      function prepareRegistrationOptions(options) {
        const normalized = Object.assign({}, options);
        if (typeof options.challenge === "string") {
          normalized.challenge = fromBase64Url(options.challenge);
        }
        normalized.user = Object.assign({}, options.user, {
          id: typeof options.user.id === "string" ? fromBase64Url(options.user.id) : options.user.id,
        });
        if (Array.isArray(options.excludeCredentials)) {
          normalized.excludeCredentials = options.excludeCredentials.map((credential) =>
            Object.assign({}, credential, {
              id: typeof credential.id === "string" ? fromBase64Url(credential.id) : credential.id,
            })
          );
        }
        return normalized;
      }

      function prepareAuthenticationOptions(options) {
        const normalized = Object.assign({}, options);
        if (typeof options.challenge === "string") {
          normalized.challenge = fromBase64Url(options.challenge);
        }
        if (Array.isArray(options.allowCredentials)) {
          normalized.allowCredentials = options.allowCredentials.map((credential) =>
            Object.assign({}, credential, {
              id: typeof credential.id === "string" ? fromBase64Url(credential.id) : credential.id,
            })
          );
        }
        return normalized;
      }

      function serializeRegistrationCredential(credential) {
        return {
          id: credential.id,
          rawId: toBase64Url(credential.rawId),
          type: credential.type,
          response: {
            clientDataJSON: toBase64Url(credential.response.clientDataJSON),
            attestationObject: toBase64Url(credential.response.attestationObject),
            transports:
              typeof credential.response.getTransports === "function"
                ? credential.response.getTransports()
                : [],
          },
          clientExtensionResults: credential.getClientExtensionResults(),
        };
      }

      function serializeAuthenticationCredential(credential) {
        return {
          id: credential.id,
          rawId: toBase64Url(credential.rawId),
          type: credential.type,
          response: {
            clientDataJSON: toBase64Url(credential.response.clientDataJSON),
            authenticatorData: toBase64Url(credential.response.authenticatorData),
            signature: toBase64Url(credential.response.signature),
            userHandle: credential.response.userHandle
              ? toBase64Url(credential.response.userHandle)
              : null,
          },
          clientExtensionResults: credential.getClientExtensionResults(),
        };
      }

      async function startGoogleOAuth() {
        try {
          const path = `${window.location.pathname}`;
          const result = await request(
            `/v1/auth/google/start?return_to=${encodeURIComponent(path)}`,
            "GET",
            null,
            false
          );
          if (result.status === 0) {
            renderOutput(
              state.locale === "he"
                ? "שגיאת רשת: לא הצלחנו להגיע לשירות ההתחברות."
                : "Network error: could not reach auth service.",
              ["auth", "oauth", "network"],
              result.payload
            );
            return;
          }
          if (!result.ok || !result.payload.authorize_url) {
            renderOutput(`OAuth failed (${result.status})`, ["auth", "oauth", "error"], result.payload);
            return;
          }
          window.location.href = result.payload.authorize_url;
        } catch (error) {
          renderOutput(`${state.locale === "he" ? "שגיאת OAuth" : "OAuth error"}: ${error.message}`, ["auth", "oauth", "network"]);
        }
      }

      async function startAppleOAuth() {
        try {
          const path = `${window.location.pathname}`;
          const result = await request(
            `/v1/auth/apple/start?return_to=${encodeURIComponent(path)}`,
            "GET",
            null,
            false
          );
          if (result.status === 0) {
            renderOutput(
              state.locale === "he"
                ? "שגיאת רשת: לא הצלחנו להגיע לשירות ההתחברות."
                : "Network error: could not reach auth service.",
              ["auth", "apple", "oauth", "network"],
              result.payload
            );
            return;
          }
          if (!result.ok || !result.payload.authorize_url) {
            renderOutput(
              `Apple OAuth failed (${result.status})`,
              ["auth", "apple", "oauth", "error"],
              result.payload
            );
            return;
          }
          window.location.href = result.payload.authorize_url;
        } catch (error) {
          renderOutput(
            `${state.locale === "he" ? "שגיאת OAuth" : "OAuth error"}: ${error.message}`,
            ["auth", "apple", "oauth", "network"]
          );
        }
      }

      async function signInWithPasskey() {
        if (!window.PublicKeyCredential) {
          renderOutput(state.locale === "he" ? "הדפדפן לא תומך Passkeys" : "Browser does not support passkeys", ["auth", "passkey"]);
          return;
        }

        const email = getIdentityEmail();
        const startPayload = email ? { email } : {};
        const start = await request("/v1/auth/passkey/login/start", "POST", startPayload, false);
        if (start.status === 0) {
          renderOutput(
            state.locale === "he"
              ? "שגיאת רשת: שירות Passkey לא נגיש כרגע."
              : "Network error: Passkey service is unreachable right now.",
            ["auth", "passkey", "network"],
            start.payload
          );
          return;
        }
        if (start.status === 503 || (start.payload && start.payload.error === "passkey_unavailable")) {
          renderOutput(
            state.locale === "he"
              ? "שירות Passkey עדיין לא מוגדר בשרת. אפשר להיכנס כרגע עם Google או Apple."
              : "Passkey is not configured on the server yet. Use Google or Apple sign-in for now.",
            ["auth", "passkey", "unavailable"],
            start.payload
          );
          return;
        }
        if (start.status >= 500) {
          renderOutput(
            state.locale === "he"
              ? "שירות ה-Passkey חווה תקלה זמנית בצד השרת (502/5xx). זה לא קשור לאימייל שלך. ננסה שוב בעוד רגע."
              : "Passkey service is temporarily failing upstream (502/5xx). This is not your email issue. Please retry shortly.",
            ["auth", "passkey", "upstream", "error"],
            start.payload
          );
          return;
        }
        if (
          start.status === 404 ||
          (start.payload && (start.payload.error === "user_not_found" || start.payload.error === "no_passkeys_registered"))
        ) {
          renderOutput(
            state.locale === "he"
              ? "לא נמצא Passkey פעיל למייל הזה. לחצו קודם על 'רישום Passkey'."
              : "No passkey found yet. Use 'Passwordless (more secure) Sign up' first.",
            ["auth", "passkey", "enroll-required"],
            start.payload
          );
          return;
        }
        if (!start.ok || !start.payload.options || !start.payload.request_id) {
          renderOutput(`Passkey login start failed (${start.status})`, ["auth", "passkey", "error"], start.payload);
          return;
        }

        const publicKey = prepareAuthenticationOptions(start.payload.options);
        let credential;
        try {
          credential = await navigator.credentials.get({ publicKey });
        } catch (error) {
          renderOutput(`${state.locale === "he" ? "אימות Passkey בוטל" : "Passkey auth cancelled"}: ${error.message}`, ["auth", "passkey"]);
          return;
        }
        if (!credential) return;

        const finish = await request("/v1/auth/passkey/login/finish", "POST", {
          request_id: start.payload.request_id,
          credential: serializeAuthenticationCredential(credential),
        }, false);
        if (!finish.ok) {
          renderOutput(`Passkey login failed (${finish.status})`, ["auth", "passkey", "error"], finish.payload);
          return;
        }

        state.user = finish.payload.user || null;
        await restoreSession();
        renderOutput(state.locale === "he" ? "התחברות Passkey הצליחה" : "Passkey sign-in complete", ["auth", "passkey"], finish.payload);
        await loadStudioPreferences();
        await loadNotes();
        await loadProactiveFeed();
      }

      async function enrollPasskey() {
        if (!window.PublicKeyCredential) {
          renderOutput(state.locale === "he" ? "הדפדפן לא תומך Passkeys" : "Browser does not support passkeys", ["auth", "passkey"]);
          return;
        }

        const email = getIdentityEmail();
        const displayName = state.user && state.user.name ? state.user.name : "Atlas Masa Member";
        const startPayload = {
          display_name: displayName,
          locale: state.locale,
        };
        if (email) startPayload.email = email;
        const start = await request("/v1/auth/passkey/register/start", "POST", {
          ...startPayload,
        }, false);
        if (start.status === 0) {
          renderOutput(
            state.locale === "he"
              ? "שגיאת רשת: שירות רישום Passkey לא נגיש כרגע."
              : "Network error: Passkey enrollment service is unreachable right now.",
            ["auth", "passkey", "network"],
            start.payload
          );
          return;
        }
        if (start.status === 503 || (start.payload && start.payload.error === "passkey_unavailable")) {
          renderOutput(
            state.locale === "he"
              ? "שירות Passkey עדיין לא מוגדר בשרת. אפשר להיכנס עם Google או Apple."
              : "Passkey is not configured on the server yet. Use Google or Apple sign-in for now.",
            ["auth", "passkey", "unavailable"],
            start.payload
          );
          return;
        }
        if (start.status >= 500) {
          renderOutput(
            state.locale === "he"
              ? "רישום Passkey נכשל בגלל תקלה זמנית בשרת (502/5xx). זה לא קשור לאימייל שלך."
              : "Passkey enrollment failed due to temporary upstream server issue (502/5xx). This is not your email issue.",
            ["auth", "passkey", "upstream", "error"],
            start.payload
          );
          return;
        }
        if (!start.ok || !start.payload.options || !start.payload.request_id) {
          renderOutput(`Passkey registration start failed (${start.status})`, ["auth", "passkey", "error"], start.payload);
          return;
        }

        const publicKey = prepareRegistrationOptions(start.payload.options);
        let credential;
        try {
          credential = await navigator.credentials.create({ publicKey });
        } catch (error) {
          renderOutput(`${state.locale === "he" ? "רישום Passkey בוטל" : "Passkey registration cancelled"}: ${error.message}`, ["auth", "passkey"]);
          return;
        }
        if (!credential) return;

        const finish = await request("/v1/auth/passkey/register/finish", "POST", {
          request_id: start.payload.request_id,
          credential: serializeRegistrationCredential(credential),
        }, false);
        if (!finish.ok) {
          renderOutput(`Passkey registration failed (${finish.status})`, ["auth", "passkey", "error"], finish.payload);
          return;
        }

        renderOutput(state.locale === "he" ? "Passkey נרשם בהצלחה" : "Passkey enrolled successfully", ["auth", "passkey"], finish.payload);
        await signInWithPasskey();
      }

      async function subscribeMonthly() {
        if (!state.user) {
          renderOutput(state.locale === "he" ? "התחבר קודם כדי להפעיל מנוי" : "Sign in first to start subscription", ["billing"]);
          return;
        }
        if (state.subscription && state.subscription.bypass) {
          renderOutput(
            state.locale === "he"
              ? "גישה מלאה פעילה בחשבון הבעלים. אין צורך בתשלום מנוי."
              : "Full owner access is active on this account. No subscription payment is required.",
            ["billing", "owner-bypass"]
          );
          return;
        }
        const result = await request("/v1/billing/create_checkout_session", "POST", {});
        if (!result.ok || !result.payload.checkout_url) {
          renderOutput(`Billing failed (${result.status})`, ["billing", "error"], result.payload);
          return;
        }
        window.location.href = result.payload.checkout_url;
      }

      async function restoreSession() {
        try {
          const result = await request("/v1/auth/me");
          if (result.ok && result.payload.user) {
            state.user = result.payload.user;
            state.subscription = result.payload.subscription || state.subscription;
          } else {
            state.user = null;
            state.subscription = { bypass: false, active: false, tier: "standard" };
            const params = new URLSearchParams(window.location.search);
            if (params.get("auth") === "success" && result.status === 401) {
              const apiBase = (result.base || "").toLowerCase();
              if (
                (window.location.hostname === "atlasmasa.com" ||
                  window.location.hostname === "www.atlasmasa.com") &&
                apiBase.includes(".up.railway.app")
              ) {
                renderOutput(
                  state.locale === "he"
                    ? "ההתחברות הצליחה, אבל עוגיית סשן נחסמת בין דומיינים. צריך API ב-api.atlasmasa.com כדי לצאת ממצב Guest קבוע."
                    : "Sign-in succeeded, but session cookie is blocked across domains. Move API to api.atlasmasa.com to unlock persistent account mode.",
                  ["auth", "session", "cross-domain", "cookie"],
                  result.payload
                );
              }
            }
          }
          updateUserState();
        } catch {
          state.user = null;
          state.subscription = { bypass: false, active: false, tier: "standard" };
          updateUserState();
        }
      }

      async function logout() {
        try {
          await request("/v1/auth/logout", "POST", {});
        } catch (_) {}
        state.user = null;
        state.subscription = { bypass: false, active: false, tier: "standard" };
        state.notes = [];
        state.activeNoteId = null;
        if (noteTitle) noteTitle.value = "";
        if (noteContent) noteContent.value = "";
        updateUserState();
      }

      async function saveProfile() {
        if (!state.user) {
          renderOutput(state.locale === "he" ? "צריך להתחבר קודם" : "Sign in first", ["profile"]);
          return;
        }

        const payload = {
          memory_opt_in: true,
          locale: state.locale,
        };

        const result = await request("/v1/profile/upsert", "POST", payload);
        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "שמירה נכשלה" : "Save failed"} (${result.status})`, ["profile", "error"], result.payload);
          return;
        }

        state.user = result.payload.user || state.user;
        updateUserState();
        renderOutput(state.locale === "he" ? "הפרופיל נשמר" : "Profile saved", ["profile", "memory_opt_in"], result.payload);
      }

      async function loadStudioPreferences() {
        try {
          const result = await request("/v1/studio/preferences");
          if (!result.ok || !result.payload.preferences) {
            syncStudioControls();
            return;
          }
          state.studio = Object.assign({}, state.studio, result.payload.preferences);
          syncStudioControls();
        } catch {
          syncStudioControls();
        }
      }

      async function saveStudioPreferences() {
        collectStudioControls();
        const result = await request("/v1/studio/preferences", "POST", state.studio);
        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "שמירת סטודיו נכשלה" : "Studio save failed"} (${result.status})`, ["studio", "error"], result.payload);
          return;
        }

        state.studio = Object.assign({}, state.studio, result.payload.preferences || {});
        syncStudioControls();
        renderOutput(state.locale === "he" ? "הגדרות סטודיו נשמרו" : "Studio settings saved", ["studio", state.studio.preferred_format]);
      }

      async function loadNotes() {
        if (!state.user) return;
        const result = await request("/v1/notes");
        if (!result.ok) return;
        state.notes = Array.isArray(result.payload.notes) ? result.payload.notes : [];
        if (state.notes.length) {
          const current = state.notes[0];
          state.activeNoteId = current.note_id;
          noteTitle.value = current.title || "";
          noteContent.value = current.content || "";
        }
      }

      async function saveNote() {
        if (!state.user) {
          renderOutput(state.locale === "he" ? "צריך להתחבר כדי לשמור פתקים" : "Sign in to save notes", ["notes"]);
          return;
        }
        const title = noteTitle.value.trim();
        const content = noteContent.value.trim();
        if (!title || !content) {
          renderOutput(state.locale === "he" ? "יש להזין כותרת ותוכן" : "Title and content are required", ["notes"]);
          return;
        }

        const result = await request("/v1/notes/upsert", "POST", {
          note_id: state.activeNoteId,
          title,
          content,
          tags: ["execution", "life-os"],
        });
        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "שמירת פתק נכשלה" : "Note save failed"} (${result.status})`, ["notes", "error"], result.payload);
          return;
        }

        state.activeNoteId = result.payload.note && result.payload.note.note_id ? result.payload.note.note_id : state.activeNoteId;
        await loadNotes();
        renderOutput(state.locale === "he" ? "הפתק נשמר והתווסף לזיכרון האישי" : "Note saved to long-term profile memory", ["notes", "saved"], result.payload);
      }

      async function rewriteActiveNote() {
        if (!state.user || !state.activeNoteId) {
          renderOutput(state.locale === "he" ? "אין פתק פעיל לשכתוב" : "No active note to rewrite", ["notes"]);
          return;
        }
        const result = await request("/v1/notes/rewrite", "POST", {
          note_id: state.activeNoteId,
          instruction:
            "Rewrite this note in high-class executive language, with clear daily actions, mid-term milestones, and strategic long-term direction.",
        });
        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "שכתוב פתק נכשל" : "Note rewrite failed"} (${result.status})`, ["notes", "error"], result.payload);
          return;
        }
        if (result.payload.note) {
          noteTitle.value = result.payload.note.title || noteTitle.value;
          noteContent.value = result.payload.note.content || noteContent.value;
          state.activeNoteId = result.payload.note.note_id || state.activeNoteId;
        }
        await loadNotes();
        renderOutput(state.locale === "he" ? "הפתק שוכתב בשפה ניהולית גבוהה" : "Note rewritten in high-level executive language", ["notes", "rewrite"], result.payload);
      }

      async function importMemoryBatch() {
        if (!state.user) {
          renderOutput(state.locale === "he" ? "צריך להתחבר כדי לייבא זיכרון" : "Sign in to import memory", ["memory"]);
          return;
        }
        const raw = (memoryImportJson && memoryImportJson.value ? memoryImportJson.value : "").trim();
        if (!raw) {
          renderOutput(state.locale === "he" ? "הדביקו JSON לייבוא" : "Paste JSON to import", ["memory"]);
          return;
        }

        let parsed;
        try {
          parsed = JSON.parse(raw);
        } catch (error) {
          renderOutput(`${state.locale === "he" ? "JSON לא תקין" : "Invalid JSON"}: ${error.message}`, ["memory", "error"]);
          return;
        }

        const items = Array.isArray(parsed) ? parsed : parsed.items;
        if (!Array.isArray(items) || !items.length) {
          renderOutput(state.locale === "he" ? "המערכת מצפה לשדה items[]" : "Expected an items[] array", ["memory", "error"]);
          return;
        }

        const result = await request("/v1/memory/import", "POST", { items });
        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "ייבוא זיכרון נכשל" : "Memory import failed"} (${result.status})`, ["memory", "error"], result.payload);
          return;
        }

        await loadNotes();
        await loadProactiveFeed();
        renderOutput(
          state.locale === "he"
            ? `ייבוא הושלם: ${result.payload.imported || 0} פריטים נשמרו.`
            : `Import complete: ${result.payload.imported || 0} items stored.`,
          ["memory", "import"],
          result.payload
        );
      }

      function localSurveyQuestions(locale) {
        const he = locale === "he";
        return [
          {
            id: "primary_goal",
            title: he ? "מה היעד המרכזי שלך כרגע?" : "What is your primary goal right now?",
            description: he
              ? "זה יכוון את המערכת בין פוקוס על בריאות, עושר או תפעול."
              : "This guides whether the system prioritizes health, wealth, or execution.",
            kind: "choice",
            choices: [
              { value: "wealth", label: he ? "בניית עושר" : "Build wealth" },
              { value: "health", label: he ? "בריאות ויציבות" : "Health and resilience" },
              { value: "execution", label: he ? "ביצוע יומי" : "Daily execution" },
            ],
          },
          {
            id: "pressure_source",
            title: he ? "מה הלחץ הכי גדול ביום-יום?" : "What causes the most pressure day-to-day?",
            description: he
              ? "נעשה התאמה יזומה סביב מקור החיכוך העיקרי."
              : "We’ll proactively adapt around your biggest friction source.",
            kind: "choice",
            choices: [
              { value: "time", label: he ? "חוסר זמן" : "Lack of time" },
              { value: "uncertainty", label: he ? "חוסר ודאות" : "Uncertainty" },
              { value: "fatigue", label: he ? "עייפות" : "Fatigue" },
            ],
          },
          {
            id: "trip_style",
            title: he ? "מה סגנון המסע המועדף עליך?" : "What is your preferred trip style?",
            description: he
              ? "הבחירה הזו תשמש את המערכת להתאמות מסלול ופיד יזום."
              : "This choice is used for route personalization and proactive feed tuning.",
            kind: "choice",
            choices: [
              { value: "mixed", label: he ? "משולב" : "Mixed" },
              { value: "beach", label: he ? "חוף" : "Beach" },
              { value: "north", label: he ? "צפון" : "North" },
              { value: "desert", label: he ? "מדבר" : "Desert" },
            ],
          },
          {
            id: "cadence",
            title: he
              ? "באיזה קצב תרצה שהמערכת תדחוף ביצוע?"
              : "How aggressively should the system push execution?",
            description: he
              ? "אפשר לשנות את זה בכל רגע בהגדרות הסטודיו."
              : "You can change this anytime in Studio settings.",
            kind: "choice",
            choices: [
              { value: "direct", label: he ? "ישיר וחד" : "Direct and sharp" },
              { value: "coach", label: he ? "מאמן תומך" : "Supportive coach" },
              { value: "strategic", label: he ? "אסטרטגי ארוך טווח" : "Long-term strategic" },
            ],
          },
        ];
      }

      function buildLocalSurveyPayload() {
        const questions = localSurveyQuestions(state.locale);
        const answers = state.survey.localAnswers || {};
        const answered = questions.filter((question) => Object.prototype.hasOwnProperty.call(answers, question.id)).length;
        const nextQuestion = questions.find((question) => !Object.prototype.hasOwnProperty.call(answers, question.id)) || null;
        const total = questions.length;
        const percent = total === 0 ? 0 : Math.round((answered / total) * 100);
        return {
          question: nextQuestion,
          progress: {
            answered,
            total,
            percent,
          },
          profile_hints: Object.keys(answers).map((key) => `${key}:${answers[key]}`),
          local_mode: true,
        };
      }

      async function loadSurveyNext() {
        const result = await request("/v1/survey/next");
        if (!result.ok) {
          const payload = buildLocalSurveyPayload();
          renderSurvey(payload);
          surveyDescription.textContent =
            state.locale === "he"
              ? "השרת לא זמין כרגע. הופעל מצב סקר מקומי עד שחיבור ה-API יחזור."
              : "API is currently unavailable. Local survey mode is active until connectivity returns.";
          renderOutput(
            state.locale === "he"
              ? "עברנו אוטומטית לסקר מקומי עד שחיבור השרת יחזור."
              : "Switched automatically to local survey mode until API connectivity returns.",
            ["survey", "adaptive", "local-mode"],
            result.payload
          );
          return;
        }
        state.survey.localAnswers = {};
        renderSurvey(result.payload);
      }

      async function submitSurveyAnswer(answerOverride = null) {
        if (!state.survey.question || !state.survey.question.id) return;
        const answer = answerOverride || state.survey.selected;
        if (!answer) {
          renderOutput(state.locale === "he" ? "בחרו תשובה בסקר" : "Select a survey answer", ["survey"]);
          return;
        }

        if (state.survey.localMode) {
          state.survey.localAnswers[state.survey.question.id] = answer;
          const payload = buildLocalSurveyPayload();
          renderSurvey(payload);
          if (!payload.question) {
            renderOutput(
              state.locale === "he"
                ? "הסקר המקומי הושלם. התחברו כדי לסנכרן ולהפעיל התאמה עמוקה מלאה."
                : "Local survey is complete. Sign in to sync and unlock full deep personalization.",
              ["survey", "fallback", "completed"],
              payload
            );
          }
          return;
        }

        const result = await request(
          "/v1/survey/answer",
          "POST",
          {
            question_id: state.survey.question.id,
            answer,
          }
        );

        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "שליחת תשובה נכשלה" : "Survey submit failed"} (${result.status})`, ["survey", "error"], result.payload);
          return;
        }

        renderSurvey(result.payload);
        const hints = result.payload.profile_hints || [];
        if (hints.length) {
          renderOutput(state.locale === "he" ? "עודכן פרופיל ההתאמה האישית" : "Personalization profile updated", ["survey", "adaptive"], { hints });
        }
      }

      async function submitFeedback() {
        const message = feedbackMessage.value.trim();
        if (!message) return;

        const result = await request(
          "/v1/feedback/submit",
          "POST",
          {
            category: "product",
            message,
            severity: "normal",
            tags: ["mobile", "daily-function"],
            target_employee: "yasha",
            source: "concierge-studio",
          }
        );

        if (!result.ok) {
          renderOutput(`${state.locale === "he" ? "פידבק לא נשלח" : "Feedback failed"} (${result.status})`, ["feedback", "error"], result.payload);
          return;
        }

        feedbackMessage.value = "";
        renderOutput(state.locale === "he" ? "הפידבק נשלח לצוות" : "Feedback sent to team", ["feedback", "yasha"], result.payload);
      }

      async function loadProactiveFeed() {
        const result = await request("/v1/feed/proactive");
        if (!result.ok) {
          renderFeed([]);
          return;
        }
        const items = result.payload.items || [];
        renderFeed(items);
      }

      async function sendChat() {
        const text = messageEl.value.trim();
        if (state.mode !== "health" && !text && state.mode !== "trip") {
          renderOutput(state.locale === "he" ? "כתבו שאלה או בחרו הצעה" : "Type a prompt or choose a suggestion", ["input"]);
          return;
        }

        if (state.mode === "health") {
          await runHealthCheck();
          renderOutput(state.locale === "he" ? "בדיקת מערכת בוצעה" : "System check complete", ["health"]);
          return;
        }

        sendBtn.disabled = true;
        try {
          if (state.mode === "trip") {
            const trip = await request(
              "/v1/plan_trip",
              "POST",
              {
                style: state.style,
                days: 3,
                locale: state.locale,
                constraints: [],
              }
            );

            if (!trip.ok) {
              await maybeOfferAutoReport(
                `${text || ""} ${trip.payload && trip.payload.message ? trip.payload.message : ""}`,
                "trip-plan-error",
                "high"
              );
              renderOutput(`${state.locale === "he" ? "יצירת מסלול נכשלה" : "Trip plan failed"} (${trip.status})`, ["trip", "error"], trip.payload);
              return;
            }

            const summary = trip.payload.summary || (state.locale === "he" ? "נוצר מסלול" : "Trip generated");
            renderOutput(summary, ["trip", state.style], trip.payload);
            renderActions([
              {
                action_type: "create_reminder",
                label: state.locale === "he" ? "תזכורת ליציאה למסלול" : "Reminder for trip departure",
                payload: {
                  title: "Atlas Masa trip departure",
                  details: summary,
                  due_at_utc: new Date(Date.now() + 90 * 60 * 1000).toISOString(),
                  reminders_app: state.studio.reminders_app,
                },
              },
            ]);
            return;
          }

          collectStudioControls();
          const result = await request(
            "/v1/chat",
            "POST",
            {
              text,
              locale: state.locale,
              preferred_format: state.studio.preferred_format,
              response_depth: state.studio.response_depth,
              response_tone: state.studio.response_tone,
              include_proactive: state.studio.proactive_mode !== "disabled",
            }
          );

          if (!result.ok) {
            await maybeOfferAutoReport(
              `${text || ""} ${result.payload && result.payload.message ? result.payload.message : ""}`,
              "chat-error",
              "high"
            );
            renderOutput(`${state.locale === "he" ? "לא הצלחנו לענות" : "Could not answer"} (${result.status})`, ["chat", "error"], result.payload);
            return;
          }

          const payload = result.payload || {};
          await maybeOfferAutoReport(text, "user-reaction", "normal");
          renderOutput(payload.reply_text || "", ["chat", payload.intent || "unknown", state.studio.preferred_format], payload);
          renderActions(payload.suggested_actions || []);
          if (payload.json_payload && payload.json_payload.proactive_feed) {
            renderFeed(payload.json_payload.proactive_feed);
          }
        } finally {
          sendBtn.disabled = false;
        }
      }

      async function handleSuggestedAction(action) {
        if (!action || !action.action_type) return;

        const payload = action.payload || {};
        if (action.action_type === "create_reminder") {
          const result = await request("/v1/actions/reminder", "POST", {
            title: payload.title || "Atlas Masa reminder",
            details: payload.details || "",
            due_at_utc: payload.due_at_utc,
            reminders_app: payload.reminders_app || state.studio.reminders_app,
          });

          if (!result.ok) {
            renderOutput(`${state.locale === "he" ? "יצירת תזכורת נכשלה" : "Reminder action failed"} (${result.status})`, ["reminder", "error"], result.payload);
            return;
          }

          const reminder = result.payload;
          if (reminder.app === "google_calendar") {
            window.open(reminder.google_calendar_url, "_blank", "noopener");
          } else if (reminder.app === "shortcuts") {
            window.location.href = reminder.shortcuts_url;
          }

          downloadTextFile(reminder.ics_content, reminder.ics_filename || "atlas-reminder.ics", "text/calendar");
          renderOutput(state.locale === "he" ? "נוצרה תזכורת + קובץ יומן" : "Reminder generated + calendar file", ["reminder", reminder.app], reminder);
          return;
        }

        if (action.action_type === "create_alarm") {
          const result = await request("/v1/actions/alarm", "POST", {
            label: payload.label || "Atlas focus",
            time_local: payload.time_local || "08:30",
            days: payload.days || ["Sun", "Mon", "Tue", "Wed", "Thu"],
            alarms_app: payload.alarms_app || state.studio.alarms_app,
          });

          if (!result.ok) {
            renderOutput(`${state.locale === "he" ? "יצירת אזעקה נכשלה" : "Alarm action failed"} (${result.status})`, ["alarm", "error"], result.payload);
            return;
          }

          const alarm = result.payload;
          if (alarm.app === "shortcuts") {
            window.location.href = alarm.shortcuts_url;
          } else {
            window.location.href = alarm.clock_url;
          }
          renderOutput(state.locale === "he" ? "נפתחה הגדרת אזעקה" : "Alarm setup opened", ["alarm", alarm.app], alarm);
          return;
        }

        if (action.action_type === "open_company_status") {
          const result = await request("/v1/company/status");
          if (!result.ok) {
            renderOutput(`${state.locale === "he" ? "טעינת סטטוס נכשלה" : "Company status failed"} (${result.status})`, ["company", "error"], result.payload);
            return;
          }
          renderOutput(result.payload.message || "", ["company", "status"], result.payload);
          return;
        }

        if (action.payload && action.payload.text) {
          messageEl.value = action.payload.text;
        }
      }

      function downloadTextFile(content, filename, mime) {
        const blob = new Blob([content], { type: mime || "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function initVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          voiceStatus.textContent = state.locale === "he" ? "מצב קולי: לא נתמך בדפדפן" : "Voice: browser unsupported";
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = state.locale === "he" ? "he-IL" : "en-US";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
          state.listening = true;
          voiceStatus.textContent = state.locale === "he" ? "מקשיב..." : "Listening...";
        };

        recognition.onend = () => {
          state.listening = false;
          voiceStatus.textContent = state.locale === "he" ? "מצב קולי: מוכן" : "Voice: ready";
        };

        recognition.onerror = (event) => {
          voiceStatus.textContent = `${state.locale === "he" ? "שגיאת קול" : "Voice error"}: ${event.error}`;
        };

        recognition.onresult = (event) => {
          const transcript = event.results && event.results[0] && event.results[0][0] ? event.results[0][0].transcript : "";
          if (!transcript) return;

          if (state.feature === "survey" && state.survey.question) {
            submitSurveyAnswer(transcript.trim());
          } else {
            messageEl.value = transcript.trim();
          }
        };
      }

      function toggleVoiceInput() {
        if (!recognition) {
          renderOutput(state.locale === "he" ? "הדפדפן לא תומך קלט קולי" : "Browser does not support voice input", ["voice"]);
          return;
        }
        if (state.listening) {
          recognition.stop();
        } else {
          recognition.lang = state.locale === "he" ? "he-IL" : "en-US";
          recognition.start();
        }
      }

      function speakOutput() {
        if (!window.speechSynthesis || !state.lastOutput) return;
        if (state.studio.voice_mode === "disabled") return;
        const utterance = new SpeechSynthesisUtterance(state.lastOutput);
        utterance.lang = state.locale === "he" ? "he-IL" : "en-US";
        utterance.rate = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }

      function setupEvents() {
        if (launchBar) {
          launchBar.addEventListener("click", (event) => {
            const button = event.target.closest("button[data-launch]");
            if (!button) return;
            applyLaunchPreset(button.dataset.launch, { userGesture: true });
          });
        }

        featureSegment.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-feature]");
          if (!button) return;
          state.feature = button.dataset.feature;
          renderFeature();
        });

        modeSegment.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-mode]");
          if (!button) return;
          state.mode = button.dataset.mode;
          renderMode();
        });

        styleSegment.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-style]");
          if (!button) return;
          state.style = button.dataset.style;
          setPressed(styleSegment, "style", state.style);
        });

        if (googleSigninBtn) googleSigninBtn.addEventListener("click", startGoogleOAuth);
        if (appleSigninBtn) appleSigninBtn.addEventListener("click", startAppleOAuth);
        if (passkeySigninBtn) passkeySigninBtn.addEventListener("click", signInWithPasskey);
        if (passkeyEnrollBtn) passkeyEnrollBtn.addEventListener("click", enrollPasskey);
        if (subscribeMonthlyBtn) subscribeMonthlyBtn.addEventListener("click", subscribeMonthly);
        if (signoutBtn) signoutBtn.addEventListener("click", logout);
        if (saveProfileBtn) saveProfileBtn.addEventListener("click", saveProfile);
        sendBtn.addEventListener("click", sendChat);
        voiceBtn.addEventListener("click", toggleVoiceInput);
        speakBtn.addEventListener("click", speakOutput);
        saveStudioBtn.addEventListener("click", saveStudioPreferences);
        loadStudioBtn.addEventListener("click", loadStudioPreferences);
        saveNoteBtn.addEventListener("click", saveNote);
        rewriteNoteBtn.addEventListener("click", rewriteActiveNote);
        loadNotesBtn.addEventListener("click", loadNotes);
        importMemoryBtn.addEventListener("click", importMemoryBatch);
        surveyNextBtn.addEventListener("click", () => submitSurveyAnswer());
        surveyVoiceBtn.addEventListener("click", toggleVoiceInput);
        sendFeedbackBtn.addEventListener("click", submitFeedback);
        refreshFeedBtn.addEventListener("click", loadProactiveFeed);

        window.addEventListener("atlas:language-change", (event) => {
          state.locale = (event && event.detail && event.detail.code) || "he";
          renderLocaleLabel();
          applyCapabilityGates();
          renderPromptSuggestions();
          if (recognition) recognition.lang = state.locale === "he" ? "he-IL" : "en-US";
        });
      }

      function setupDebugMode() {
        const debug = new URLSearchParams(window.location.search).get("debug") === "1";
        if (!debug) return;
        const details = document.getElementById("debug-controls");
        if (details) details.style.display = "block";
      }

      function handleStatusFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const auth = params.get("auth");
        const reason = params.get("reason");
        const billing = params.get("billing");

        if (auth === "success") {
          renderOutput(
            state.locale === "he" ? "אימות OAuth הושלם בהצלחה." : "OAuth sign-in completed successfully.",
            ["auth", "oauth", "success"]
          );
        } else if (auth === "error") {
          renderOutput(`${state.locale === "he" ? "שגיאת OAuth" : "OAuth error"}: ${reason || "unknown"}`, ["auth", "oauth", "error"]);
        }

        if (billing === "success") {
          renderOutput(state.locale === "he" ? "המנוי החודשי הופעל בהצלחה." : "Monthly subscription activated successfully.", ["billing", "active"]);
        } else if (billing === "cancel") {
          renderOutput(state.locale === "he" ? "תהליך התשלום בוטל." : "Checkout was canceled.", ["billing", "canceled"]);
        } else if (billing === "owner_bypass") {
          renderOutput(
            state.locale === "he"
              ? "גישה מלאה בחשבון בעלים הופעלה ללא חיוב."
              : "Owner full access activated with no subscription charge.",
            ["billing", "owner-bypass"]
          );
        }
      }

      function handleLaunchFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const launch = params.get("launch");
        if (!launch) return;
        applyLaunchPreset(launch, { userGesture: false });
      }

      async function bootstrap() {
        state.locale = getSiteLocale();
        renderLocaleLabel();
        setupDebugMode();
        handleStatusFromQuery();
        handleLaunchFromQuery();
        if (apiBaseInput) {
          apiBaseInput.value = inferApiBase();
        }

        setupEvents();
        renderFeature();
        renderMode();
        setPressed(styleSegment, "style", state.style);
        syncStudioControls();
        applyCapabilityGates();
        initVoice();

        await runHealthCheck();
        await restoreSession();
        await loadStudioPreferences();
        await loadNotes();
        await loadSurveyNext();
        await loadProactiveFeed();

        // Unprompted proactive refresh loop (mobile-safe cadence).
        setInterval(() => {
          if (state.studio.proactive_mode !== "disabled") {
            loadProactiveFeed();
          }
        }, 120000);
      }

      bootstrap();
    </script>
  </body>
</html>
