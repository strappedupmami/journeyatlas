name: ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  policy-guard:
    name: policy-guard
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Verify lockfile policy
        run: ./scripts/verify-lockfiles.sh sync-check

      - name: Verify actions are SHA-pinned
        run: ./scripts/verify-github-actions-pinning.sh

      - name: Verify workflow trust boundaries
        run: ./scripts/verify-workflow-trust-boundaries.sh

      - name: Verify dependency bot PR scope
        run: ./scripts/verify-dependency-pr-scope.sh

  rust-ci:
    name: rust-ci
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    needs: policy-guard
    runs-on: ubuntu-latest
    timeout-minutes: 35
    defaults:
      run:
        working-directory: atlas-concierge
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal --no-self-update
          rustup default stable
          rustup component add clippy rustfmt

      - name: Format check
        run: cargo fmt --all --check

      - name: Lint
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Test
        run: cargo test -p atlas-tests --locked

  web-ci:
    name: web-ci
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    needs: policy-guard
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --ignore-scripts --no-audit --fund=false

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build
        run: npm run build

  dependency-audit:
    name: dependency-audit
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    needs: policy-guard
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: npm audit (production deps)
        run: |
          npm ci --ignore-scripts --fund=false
          npm audit --omit=dev --audit-level=high

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal --no-self-update
          rustup default stable

      - name: cargo audit
        working-directory: atlas-concierge
        run: |
          cargo install cargo-audit --locked
          cargo audit --deny warnings
